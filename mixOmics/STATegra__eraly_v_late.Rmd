---
title: "STATegra Control vs Ikarus"
output: html_document
date: "`r Sys.Date()`"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(mixOmics) 
library(data.table)
library(dplyr)
library(stringr)
library(tibble)

set.seed(3430)
#setwd("/proj/raman/4_Praktikum_Steininger/MulitOmics/STATegra")

# define a report name that is used as a prefix 
report_name <- 'con_v_ika'

# create directory for report, if not already existing
output_dir = file.path(getwd(),"STATegra_output", report_name)
ifelse(!dir.exists(output_dir), dir.create(output_dir, recursive =TRUE ), FALSE)

# define paths
image_path <- file.path(output_dir)
data_path = "../datasets/STATegra/export_variance_threshold"

```


# Reading data sets

## Load the targets associated with every sample

```{r}
targets <-  read.csv(file.path(data_path, "targets.csv"), row.names = 1)
```


## Proteins

```{r}
# read protein data
proteins <- read.csv(file.path(data_path, "proteomics.csv"), row.names = 1)
proteins <- as.data.frame(proteins) %>% mutate(target = targets$group)

```

## Metabolites
```{r}
# read metabolite data
metabolites <- read.csv(file.path(data_path, "metabolomics.csv"), row.names = 1)
metabolites <- as.data.frame(metabolites) %>% mutate(target = targets$group)

```

## Transcriptome data
```{r}
# read metabolite data
transcriptome <- read.csv(file.path(data_path, "transcriptomics.csv"), row.names = 1)
transcriptome <- as.data.frame(transcriptome) %>% mutate(target = targets$group)
```

# Combine omics data to list
```{r}
# define list of labels
Y <- targets$group

# define combined dataset
data <- list(Proteomics = subset(proteins, select=-c(target)),
             Metabolomics =  subset(metabolites, select=-c(target)),
              Transcriptomics =  subset(transcriptome, select=-c(target)))

```

# Peform sparse partial least squares regression
```{r}
list.keepX = c(25, 25) # select arbitrary values of features to keep
list.keepY = c(25, 25)

pls1 <- spls(data[["Proteomics"]], data[["Metabolomics"]], keepX = list.keepX, keepY = list.keepY)
pls2 <- spls(data[["Proteomics"]], data[["Transcriptomics"]], keepX = list.keepX, keepY = list.keepY)
pls3 <- spls(data[["Transcriptomics"]], data[["Metabolomics"]], keepX = list.keepX, keepY = list.keepY)

png(file.path(image_path, 'circle_corr_plot_prot_met.png'))
plotVar(pls1, cutoff = 0.5, title = "Proteins vs Metabolites", 
        legend = c("Proteomics", "Metabolomics"), 
        var.names = FALSE, style = 'graphics', 
        pch = c(16, 17), cex = c(2,2), 
        col = c('darkorchid', 'lightgreen'))
dev.off()

cor(pls1$variates$X, pls1$variates$Y) 

png(file.path(image_path, 'circle_corr_plot_prot_trans.png'))
plotVar(pls2, cutoff = 0.5, title = "Proteins vs Transciptome", 
        legend = c("Proteomics", "Transciptomics"), 
        var.names = FALSE, style = 'graphics', 
        pch = c(16, 17), cex = c(2,2), 
        col = c('darkorchid', 'lightgreen'))
dev.off()

cor(pls2$variates$X, pls2$variates$Y) 

png(file.path(image_path, 'circle_corr_plot_trans_met.png'))
plotVar(pls3, cutoff = 0.5, title = "Transciptome vs Metabolites", 
        legend = c("Transciptome", "Metabolomics"), 
        var.names = FALSE, style = 'graphics', 
        pch = c(16, 17), cex = c(2,2), 
        col = c('darkorchid', 'lightgreen'))
dev.off()

cor(pls3$variates$X, pls3$variates$Y) 
```
# DIABLO
## Design matrix
In mixOmixs, a design matrix refers to the relationship structure between the various inputted data frames. Each cell can have a value between 0 and 1, with 1 meaning that the respective data sets have a strong relationship, and 0 that the respective data sets have no relationship. The design matrix should reflect the biological question under inspection.
```{r}
# create square matrix filled with 0.1s
design = matrix(0.1, ncol = length(data), nrow = length(data), 
                dimnames = list(names(data), names(data)))
diag(design) = 0 # set diagonal to 0s

design

# form basic DIABLO model
basic.diablo.model = block.splsda(X = data, Y = Y, ncomp = 5, design = design,
                                  near.zero.var = TRUE) 
```
## Tuning number of components
```{r}
perf.diablo = perf(basic.diablo.model, validation = 'loo', 
                   folds = 3, nrepeat = 10) #used 3 folds because in each fold should be at least
png(file.path(image_path, 'classification_error_rate.png'))
plot(perf.diablo) # plot output of tuning

# set the optimal ncomp value
ncomp = perf.diablo$choice.ncomp$WeightedVote["Overall.BER", "centroids.dist"]

# show the optimal choice for ncomp for each dist metric
perf.diablo$choice.ncomp$WeightedVote 
```
## Tuning number of features
```{r}
# set grid of values for each component to test
test.keepX = list (Proteomics = c(5, 1, 15, 20, 25), 
                   Metabolomics = c(5, 1, 15, 20, 25),
                   Transcriptomics = c(5, 1, 15, 20, 25))

# run the feature selection tuning
tune.stratega = tune.block.splsda(X = data, Y = Y, ncomp = ncomp, 
                              test.keepX = test.keepX, design = design,
                              validation = 'Mfold', folds = 5, nrepeat = 1,
                              dist = "centroids.dist",
                              near.zero.var = TRUE) # noch nicht angeschaut was das tut

list.keepX = tune.stratega$choice.keepX # set the optimal values of features to retain
list.keepX
```
## Final DIABLO model
```{r}
# set the optimised DIABLO model
final.diablo.model = block.splsda(X = data, Y = Y, ncomp = ncomp, 
                                design = design,
                                keepX = list.keepX,
                                near.zero.var = TRUE)

final.diablo.model$design # design matrix for the final model
```
### Inspect selected features in each Omics data set
```{r}
# the features selected to form the first component
selectVar(final.diablo.model, block = 'Proteomics', comp = 1)$Proteomics$name 
# the features selected to form the first component
selectVar(final.diablo.model, block = 'Metabolomics', comp = 1)$Metabolomics$name 
# the features selected to form the first component
selectVar(final.diablo.model, block = 'Transcriptomics', comp = 1)$Transcriptomics$name 
```
### Plots for DIABLO
```{r}
png(file.path(image_path, 'sample_plot.png'))
plotIndiv(final.diablo.model, ind.names = FALSE, legend = TRUE, 
          title = 'DIABLO Sample Plots')
dev.off()

png(file.path(image_path, 'arrow_plot.png'))
plotArrow(final.diablo.model, ind.names = FALSE, legend = TRUE, 
          title = 'DIABLO')
dev.off()

#png(file.path(image_path, 'vaiable_plot.png'))
#plotVar(final.diablo.model, var.names = FALSE, 
        #style = 'graphics', legend = TRUE,
        #pch = c(16, 17), cex = c(2,2), 
        #col = c('darkorchid', 'lightgreen'))
#dev.off()

png(file.path(image_path, 'loadings.png'))
plotLoadings(final.diablo.model, comp = 2, contrib = 'max', method = 'median', size.legend = 0.65 )
dev.off()

#png(file.path(image_path, 'network.png'))
#network(final.diablo.model, blocks = c(1,2),
        #color.node = c('darkorchid', 'lightgreen'), cutoff = 0.4)
#dev.off()
```
# Results
```{r}
png(file.path(image_path, 'diablo_plot.png'))
plotDiablo(final.diablo.model, ncomp = 1)
dev.off()

png(file.path(image_path, 'cim_plot.png'), width = 480, height = 480)
cimDiablo(final.diablo.model,
          legend.position = "topright",
          trim=TRUE,
          row.names = FALSE,
          size.legend = 0.65,
          margins = c(8, 12),
          col.cex = 1,
          cut.tree = c(0.5,1),
          cluster = "both",
          color.blocks = c('darkorchid', 'lightgreen', 'lightblue'))
dev.off()

png(file.path(image_path, 'circus_plot.png'),width = 1000, height = 480)
circosPlot(final.diablo.model, 
           cutoff = 0.7, 
           line = TRUE,
           color.blocks= c('darkorchid', 'lightgreen', 'lightblue'),
           color.cor = c("chocolate3","grey20"), 
           size.labels = 2,
           size.legend = 1.2,
           size.variables = 1,
           showIntraLinks = TRUE,
           ncol.legend = 1)
dev.off()
```


